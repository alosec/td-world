#!/usr/bin/env bash
# tv - Todo Viewer for td (fzf-powered)
# bv-inspired: table view, enter for full-screen detail
set -euo pipefail

VERSION="0.4.0"
DB="$HOME/.td/tasks.db"

# Dracula palette
C_PURPLE="\033[38;2;189;147;249m"
C_CYAN="\033[38;2;139;233;253m"
C_GREEN="\033[38;2;80;250;123m"
C_ORANGE="\033[38;2;255;184;108m"
C_RED="\033[38;2;255;85;85m"
C_YELLOW="\033[38;2;241;250;140m"
C_PINK="\033[38;2;255;121;198m"
C_MUTED="\033[38;2;98;114;164m"
C_FG="\033[38;2;248;248;242m"
C_RESET="\033[0m"
C_BOLD="\033[1m"
C_DIM="\033[2m"

die() { echo -e "${C_RED}error:${C_RESET} $1" >&2; exit 1; }
[[ -f "$DB" ]] || die "td not initialized"

get_project() { echo "${TD_PROJECT:-$(basename "$PWD")}"; }
sql() { sqlite3 -separator $'\t' "$DB" "$1"; }

# Type icons
type_icon() {
  case "$1" in
    bug) echo -e "${C_RED}●${C_RESET}" ;;
    feature) echo -e "${C_ORANGE}◆${C_RESET}" ;;
    epic) echo -e "${C_PURPLE}★${C_RESET}" ;;
    chore) echo -e "${C_CYAN}○${C_RESET}" ;;
    *) echo -e "${C_MUTED}·${C_RESET}" ;;
  esac
}

# Priority badge
prio_badge() {
  case "$1" in
    0) echo -e "${C_RED}${C_BOLD}P0${C_RESET}" ;;
    1) echo -e "${C_ORANGE}P1${C_RESET}" ;;
    2) echo -e "${C_YELLOW}P2${C_RESET}" ;;
    3) echo -e "${C_GREEN}P3${C_RESET}" ;;
    *) echo -e "${C_MUTED}P?${C_RESET}" ;;
  esac
}

# Status badge
status_badge() {
  local status="$1" stype="$2"
  case "$stype" in
    backlog) echo -e "${C_MUTED}$status${C_RESET}" ;;
    unstarted) echo -e "${C_YELLOW}$status${C_RESET}" ;;
    started) echo -e "${C_CYAN}$status${C_RESET}" ;;
    completed) echo -e "${C_GREEN}$status${C_RESET}" ;;
    canceled) echo -e "${C_RED}${C_DIM}$status${C_RESET}" ;;
    *) echo -e "${C_MUTED}$status${C_RESET}" ;;
  esac
}

# Table row - ID first for fzf extraction
format_row() {
  local id="$1" status="$2" stype="$3" prio="$4" title="$5" itype="$6" blocked="$7"
  local w=${COLUMNS:-80}
  
  local icon=$(type_icon "$itype")
  local pb=$(prio_badge "$prio")
  local blk=""
  [[ -n "$blocked" ]] && blk="▪"
  
  # Title width calculation
  local fixed=32
  local tw=$((w - fixed))
  [[ $tw -lt 10 ]] && tw=10
  [[ ${#title} -gt $tw ]] && title="${title:0:$((tw-1))}…"
  
  # Compact table: ID ICON PRIO STATUS [BLOCKED] TITLE
  if [[ -n "$blk" ]]; then
    printf "%-13s %s %s %-8s ${C_RED}%s${C_RESET} %s\n" "$id" "$icon" "$pb" "$status" "$blk" "$title"
  else
    printf "%-13s %s %s %-8s   %s\n" "$id" "$icon" "$pb" "$status" "$title"
  fi
}

# Get tasks sorted: priority, then unblocked first, then status
get_tasks() {
  local proj=$(get_project)
  local filter="t.project='$proj'"
  [[ "${ALL_PROJECTS:-}" == "1" ]] && filter="1=1"
  
  sql "SELECT t.id, t.status, COALESCE(s.type,'backlog'), t.priority, t.title, 
              COALESCE(t.type,'task'),
              (SELECT GROUP_CONCAT(blocker_id) FROM blockers b 
               JOIN tasks bt ON b.blocker_id=bt.id 
               JOIN statuses bs ON bt.project=bs.project AND bt.status=bs.name
               WHERE b.task_id=t.id AND bs.type NOT IN ('completed','canceled'))
       FROM tasks t 
       LEFT JOIN statuses s ON t.project=s.project AND t.status=s.name 
       WHERE $filter AND t.archived=0 AND s.type NOT IN ('completed', 'canceled')
       ORDER BY 
         t.priority ASC,
         CASE WHEN (SELECT COUNT(*) FROM blockers b 
                    JOIN tasks bt ON b.blocker_id=bt.id 
                    JOIN statuses bs ON bt.project=bs.project AND bt.status=bs.name
                    WHERE b.task_id=t.id AND bs.type NOT IN ('completed','canceled')) > 0 
              THEN 1 ELSE 0 END ASC,
         s.position ASC,
         t.created ASC;"
}

# Full-screen detail view
show_detail() {
  local id="$1"
  local task=$(sql "SELECT t.id, t.project, t.title, t.status, COALESCE(s.type,''), t.priority, 
                           COALESCE(t.type,'task'), t.description, t.close_reason, t.parent, 
                           t.created, t.updated
                    FROM tasks t
                    LEFT JOIN statuses s ON t.project=s.project AND t.status=s.name
                    WHERE t.id='$id';")
  
  [[ -z "$task" ]] && echo "Not found: $id" && return 1
  
  IFS=$'\t' read -r tid proj title status stype prio itype desc reason parent created updated <<< "$task"
  
  clear
  
  # Header
  echo -e "${C_PURPLE}${C_BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${C_RESET}"
  echo -e "${C_BOLD}${C_FG}$title${C_RESET}"
  echo -e "${C_PURPLE}${C_BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${C_RESET}"
  echo ""
  
  # Metadata
  local icon=$(type_icon "$itype")
  local pb=$(prio_badge "$prio")
  local sb=$(status_badge "$status" "$stype")
  
  echo -e "  ${C_MUTED}ID${C_RESET}        $tid"
  echo -e "  ${C_MUTED}Type${C_RESET}      $icon $itype"
  echo -e "  ${C_MUTED}Priority${C_RESET}  $pb"
  echo -e "  ${C_MUTED}Status${C_RESET}    $sb"
  [[ -n "$parent" ]] && echo -e "  ${C_MUTED}Parent${C_RESET}    $parent"
  
  local labels=$(sql "SELECT GROUP_CONCAT(label, ', ') FROM labels WHERE task_id='$id';")
  [[ -n "$labels" ]] && echo -e "  ${C_MUTED}Labels${C_RESET}    ${C_CYAN}$labels${C_RESET}"
  
  local blockers=$(sql "SELECT GROUP_CONCAT(blocker_id, ', ') FROM blockers WHERE task_id='$id';")
  [[ -n "$blockers" ]] && echo -e "  ${C_MUTED}Blocked by${C_RESET} ${C_RED}$blockers${C_RESET}"
  
  local blocking=$(sql "SELECT GROUP_CONCAT(task_id, ', ') FROM blockers WHERE blocker_id='$id';")
  [[ -n "$blocking" ]] && echo -e "  ${C_MUTED}Blocks${C_RESET}    ${C_ORANGE}$blocking${C_RESET}"
  
  echo -e "  ${C_MUTED}Created${C_RESET}   $created"
  [[ "$updated" != "$created" ]] && echo -e "  ${C_MUTED}Updated${C_RESET}   $updated"
  [[ -n "$reason" ]] && echo -e "  ${C_MUTED}Closed${C_RESET}    $reason"
  
  # Description
  if [[ -n "$desc" ]]; then
    echo ""
    echo -e "${C_MUTED}──────────────────────────────────────────────────────────────────────────────${C_RESET}"
    echo ""
    echo "$desc" | fold -s -w 78
  fi
  
  # Comments
  local comments=$(sql "SELECT created, body FROM comments WHERE task_id='$id' ORDER BY created;")
  if [[ -n "$comments" ]]; then
    echo ""
    echo -e "${C_PURPLE}${C_BOLD}Comments${C_RESET}"
    echo -e "${C_MUTED}──────────────────────────────────────────────────────────────────────────────${C_RESET}"
    echo "$comments" | while IFS=$'\t' read -r cdate cbody; do
      echo ""
      echo -e "  ${C_MUTED}$cdate${C_RESET}"
      echo "$cbody" | fold -s -w 74 | sed 's/^/  /'
    done
  fi
  
  # Subtasks
  local subtasks=$(sql "SELECT id, status, priority, title FROM tasks WHERE parent='$id' ORDER BY priority, id;")
  if [[ -n "$subtasks" ]]; then
    echo ""
    echo -e "${C_PURPLE}${C_BOLD}Subtasks${C_RESET}"
    echo -e "${C_MUTED}──────────────────────────────────────────────────────────────────────────────${C_RESET}"
    echo ""
    echo "$subtasks" | while IFS=$'\t' read -r sid sstatus sprio stitle; do
      local mark="${C_MUTED}○${C_RESET}"
      [[ "$sstatus" == "done" ]] && mark="${C_GREEN}●${C_RESET}"
      [[ "$sstatus" == "canceled" ]] && mark="${C_RED}✗${C_RESET}"
      [[ "$sstatus" == "in-progress" ]] && mark="${C_CYAN}◐${C_RESET}"
      local spb=$(prio_badge "$sprio")
      echo -e "  $mark $spb ${C_MUTED}$sid${C_RESET} $stitle"
    done
  fi
  
  echo ""
  echo -e "${C_MUTED}──────────────────────────────────────────────────────────────────────────────${C_RESET}"
  echo -e "${C_MUTED}Press q/ESC to return${C_RESET}"
  
  # Wait for keypress
  while true; do
    read -rsn1 key
    case "$key" in
      q|Q) break ;;
      $'\e') break ;;  # ESC
    esac
  done
}

# Kanban view
kanban_view() {
  local proj=$(get_project)
  echo -e "\n${C_BOLD}${C_PURPLE}$proj${C_RESET}\n"
  
  sql "SELECT s.name, s.type, 
       (SELECT COUNT(*) FROM tasks t WHERE t.project=s.project AND t.status=s.name)
       FROM statuses s WHERE s.project='$proj' ORDER BY s.position;" | \
  while IFS=$'\t' read -r name stype cnt; do
    local sb=$(status_badge "$name" "$stype")
    echo -e "$sb ${C_MUTED}($cnt)${C_RESET}"
    
    sql "SELECT id, priority, title, COALESCE(type,'task') FROM tasks 
         WHERE project='$proj' AND status='$name' 
         ORDER BY priority LIMIT 5;" | \
    while IFS=$'\t' read -r tid tpri ttitle ttype; do
      local icon=$(type_icon "$ttype")
      local pb=$(prio_badge "$tpri")
      echo -e "  $icon $pb ${C_MUTED}$tid${C_RESET} ${ttitle:0:45}"
    done
    echo ""
  done
}

# Stats
stats_view() {
  local proj=$(get_project)
  echo -e "\n${C_BOLD}${C_PURPLE}$proj${C_RESET}\n"
  
  sql "SELECT s.name, s.type, COUNT(t.id)
       FROM statuses s
       LEFT JOIN tasks t ON s.project=t.project AND s.name=t.status
       WHERE s.project='$proj'
       GROUP BY s.name ORDER BY s.position;" | \
  while IFS=$'\t' read -r name stype cnt; do
    local sb=$(status_badge "$name" "$stype")
    printf "  %-14b %3d\n" "$sb" "$cnt"
  done
  
  local total=$(sql "SELECT COUNT(*) FROM tasks WHERE project='$proj';")
  local blocked=$(sql "SELECT COUNT(DISTINCT task_id) FROM blockers b
                       JOIN tasks t ON b.task_id=t.id
                       JOIN tasks bt ON b.blocker_id=bt.id
                       JOIN statuses bs ON bt.project=bs.project AND bt.status=bs.name
                       WHERE t.project='$proj' AND bs.type NOT IN ('completed','canceled');")
  echo ""
  echo -e "  ${C_MUTED}Total${C_RESET}     $total"
  echo -e "  ${C_MUTED}Blocked${C_RESET}   $blocked"
  echo ""
}

# Ready view
ready_view() {
  local proj=$(get_project)
  echo -e "\n${C_BOLD}${C_GREEN}Ready (unblocked)${C_RESET}\n"
  
  sql "SELECT t.id, t.priority, t.title, COALESCE(t.type,'task')
       FROM tasks t
       LEFT JOIN statuses s ON t.project=s.project AND t.status=s.name
       WHERE t.project='$proj' AND s.type IN ('backlog','unstarted','started')
       AND t.id NOT IN (
         SELECT b.task_id FROM blockers b
         JOIN tasks bt ON b.blocker_id=bt.id
         JOIN statuses bs ON bt.project=bs.project AND bt.status=bs.name
         WHERE bs.type NOT IN ('completed','canceled')
       )
       ORDER BY t.priority, t.created LIMIT 20;" | \
  while IFS=$'\t' read -r tid tpri ttitle ttype; do
    local icon=$(type_icon "$ttype")
    local pb=$(prio_badge "$tpri")
    echo -e "  $icon $pb ${C_MUTED}$tid${C_RESET} $ttitle"
  done
  echo ""
}

export TV_SCRIPT="${BASH_SOURCE[0]}"
export DB C_PURPLE C_CYAN C_GREEN C_ORANGE C_RED C_YELLOW C_PINK C_MUTED C_FG C_RESET C_BOLD C_DIM
export -f type_icon prio_badge status_badge format_row sql get_project get_tasks show_detail

main() {
  local proj=$(get_project)
  
  while true; do
    # Build task list
    local tasks=""
    while IFS=$'\t' read -r id status stype prio title itype blocked; do
      tasks+="$(format_row "$id" "$status" "$stype" "$prio" "$title" "$itype" "$blocked")"$'\n'
    done < <(get_tasks)
    
    [[ -z "$tasks" ]] && echo "No tasks. td create \"title\"" && exit 0
    
    # Run fzf - table only, no preview
    local selected
    selected=$(echo -e "$tasks" | fzf --ansi \
      --header "$proj │ ↵:view d:done x:cancel m:move n:new" \
      --no-preview \
      --bind "ctrl-d:execute-silent(td close {1})+reload(source '$TV_SCRIPT'; get_tasks | while IFS=\$'\t' read -r id status stype prio title itype blocked; do format_row \"\$id\" \"\$status\" \"\$stype\" \"\$prio\" \"\$title\" \"\$itype\" \"\$blocked\"; done)" \
      --bind "ctrl-x:execute-silent(td cancel {1})+reload(source '$TV_SCRIPT'; get_tasks | while IFS=\$'\t' read -r id status stype prio title itype blocked; do format_row \"\$id\" \"\$status\" \"\$stype\" \"\$prio\" \"\$title\" \"\$itype\" \"\$blocked\"; done)" \
      --bind "ctrl-m:execute(echo -n 'status: ' >&2; read -r s </dev/tty; td move {1} \"\$s\" >/dev/null 2>&1)+reload(source '$TV_SCRIPT'; get_tasks | while IFS=\$'\t' read -r id status stype prio title itype blocked; do format_row \"\$id\" \"\$status\" \"\$stype\" \"\$prio\" \"\$title\" \"\$itype\" \"\$blocked\"; done)" \
      --bind "ctrl-n:execute(echo -n 'title: ' >&2; read -r t </dev/tty; td create \"\$t\" >/dev/null 2>&1)+reload(source '$TV_SCRIPT'; get_tasks | while IFS=\$'\t' read -r id status stype prio title itype blocked; do format_row \"\$id\" \"\$status\" \"\$stype\" \"\$prio\" \"\$title\" \"\$itype\" \"\$blocked\"; done)" \
      --color "header:dim,pointer:magenta,marker:magenta" \
      --no-mouse \
      --cycle \
      --expect=enter \
    ) || exit 0
    
    # Parse fzf output: first line is key, second is selection
    local key=$(echo "$selected" | head -1)
    local line=$(echo "$selected" | tail -1)
    local id=$(echo "$line" | awk '{print $1}')
    
    if [[ "$key" == "enter" && -n "$id" ]]; then
      show_detail "$id"
    else
      exit 0
    fi
  done
}

# Entry points
case "${1:-}" in
  -a|--all) export ALL_PROJECTS=1; shift; main ;;
  -k|--kanban) kanban_view ;;
  -r|--ready) ready_view ;;
  -s|--stats) stats_view ;;
  -h|--help) echo "tv [-a] [-k] [-r] [-s]" ;;
  --version) echo "tv $VERSION" ;;
  --list) get_tasks | while IFS=$'\t' read -r id status stype prio title itype blocked; do
            format_row "$id" "$status" "$stype" "$prio" "$title" "$itype" "$blocked"
          done ;;
  *) main ;;
esac
